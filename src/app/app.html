<div class="page-shell">
  @if (notifications().length) {
    <div class="toast-stack">
      @for (toast of notifications(); track toast.id) {
        <div class="toast" [class]="toast.tone">
          <p>{{ toast.text }}</p>
          <button type="button" (click)="dismissToast(toast.id)" aria-label="Dismiss notification">
            ‚úï
          </button>
        </div>
      }
    </div>
  }

  @if (!isAuthenticated()) {
    <div class="auth-prompt">
      <div class="auth-prompt-content">
        <h2>Welcome to Blockchain Payments</h2>
        <p>Please sign in or create an account to continue</p>
        <div class="auth-prompt-actions">
          <a routerLink="/login" class="primary">Sign in</a>
          <a routerLink="/signup" class="secondary">Create account</a>
        </div>
      </div>
    </div>
  } @else {
    <nav class="top-nav">
      <div class="nav-content">
        <div class="nav-brand">
          <h3>Blockchain Payments</h3>
        </div>
        <div class="nav-actions">
          <span class="user-email">{{ authService.authState().userEmail }}</span>
          <button type="button" class="ghost" (click)="toggleAccountSettings()" title="Manage Account">
            Account
          </button>
          <button type="button" class="ghost" (click)="logout()">Logout</button>
        </div>
      </div>
    </nav>
  }

  @if (isAuthenticated()) {
    <header class="hero">
    <div class="hero-copy">
      <p class="eyebrow">Blockchain-native payments orchestration</p>
      <h1>Launch an auditable Web3 payment desk in minutes.</h1>
      <p class="lede">
        Connect your MetaMask wallet, orchestrate settlement across EVM chains, and let the backend
        you built keep compliance checks, policy routing, and payment intelligence humming.
      </p>
      <div class="hero-actions">
        @if (walletState().connected) {
          <div class="send-receive-buttons">
            <button
              type="button"
              class="send-btn"
              [class.active]="showSendTile()"
              (click)="toggleSendTile()"
              title="Send payment by phone number"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
              Send
            </button>
            <button
              type="button"
              class="receive-btn"
              [class.active]="showQRCodeTile()"
              (click)="toggleQRCodeTile()"
              title="Show QR code to receive payments"
            >
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="5" height="5"></rect>
                <rect x="16" y="3" width="5" height="5"></rect>
                <rect x="3" y="16" width="5" height="5"></rect>
                <path d="M21 16h-3a2 2 0 0 1-2-2v-3"></path>
                <path d="M21 21v.01"></path>
                <path d="M12 7v3a2 2 0 0 1-2 2H7"></path>
                <path d="M3 12h.01"></path>
                <path d="M12 3h.01"></path>
                <path d="M12 16v.01"></path>
                <path d="M16 12h.01"></path>
                <path d="M16 16v.01"></path>
                <path d="M12 21h.01"></path>
              </svg>
              Receive
            </button>
          </div>
        }
        <button
          type="button"
          class="primary"
          (click)="connectWallet()"
          [disabled]="connectingWallet()"
        >
          @if (connectingWallet()) {
            <span class="loader"></span>
            Connecting...
          } @else if (walletState().connected) {
            Switch Wallet / Reconnect
          } @else {
            Connect Your MetaMask Wallet
          }
        </button>
      </div>
      
      <!-- Send Tile (Phone Search) -->
      @if (showSendTile() && walletState().connected) {
        <div class="action-tile send-tile">
          <div class="tile-header">
            <h3>Send Payment</h3>
            <button type="button" class="tile-close" (click)="toggleSendTile()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="tile-content">
            <!-- Phone Number Search Card Content -->
            <div class="phone-search-content">
              <div class="phone-search-input-group">
                <div class="phone-search-input-wrapper">
                  <input
                    type="tel"
                    [value]="phoneSearchInput()"
                    (input)="phoneSearchInput.set($any($event.target).value)"
                    placeholder="Enter 10-digit phone number (e.g., 9876543210)"
                    autocomplete="off"
                    class="phone-search-input"
                  />
                  @if (phoneSearchInput()) {
                    <button
                      type="button"
                      class="input-clear-btn"
                      (click)="clearPhoneSearch()"
                      aria-label="Clear phone number"
                    >
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  }
                </div>
                <button
                  type="button"
                  class="primary"
                  (click)="searchWalletByPhone()"
                  [disabled]="!phoneSearchInput() || searchingPhone()"
                  [class.disabled]="!phoneSearchInput() || searchingPhone()"
                >
                  @if (searchingPhone()) {
                    <span class="loader"></span>
                    Searching...
                  } @else {
                    Search
                  }
                </button>
              </div>
              
              @if (searchingPhone()) {
                <div class="phone-search-status">
                  <span class="loader"></span>
                  <span>Searching for wallet addresses...</span>
                </div>
              } @else if (showPhoneResults() && phoneSearchResults().length > 0) {
                <div class="phone-search-results-card">
                  <p style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
                    Found {{ phoneSearchResults().length }} address{{ phoneSearchResults().length > 1 ? 'es' : '' }}. Click to use:
                  </p>
                  <div class="phone-search-results-list">
                    @for (result of phoneSearchResults(); track result.address) {
                      <button
                        type="button"
                        class="wallet-address-item"
                        (click)="selectWalletAddress(result.address)"
                      >
                        <span class="wallet-address-full">{{ result.address }}</span>
                        <span class="wallet-address-short">{{ formatAddress(result.address) }}</span>
                      </button>
                    }
                  </div>
                </div>
              } @else if (showPhoneResults() && phoneSearchResults().length === 0 && phoneSearchQuery()) {
                <div class="phone-search-no-results">
                  <p>No wallet address found for that phone number.</p>
                </div>
              }
            </div>
          </div>
        </div>
      }
      
      <!-- Receive Tile (QR Code) -->
      @if (showQRCodeTile() && walletState().connected) {
        <div class="action-tile receive-tile">
          <div class="tile-header">
            <h3>Receive Payment</h3>
            <button type="button" class="tile-close" (click)="toggleQRCodeTile()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="tile-content">
            <div class="qr-code-container">
              @if (qrCodeDataUrl()) {
                <img [src]="qrCodeDataUrl()" alt="Wallet QR Code" class="qr-code-image" />
              } @else {
                <div class="qr-loading">
                  <span class="loader"></span>
                  <p>Generating QR code...</p>
                </div>
              }
            </div>
            
            <div class="wallet-address-display">
              <p class="address-label">Your Wallet Address</p>
              <div class="address-box">
                <p class="address-text">{{ walletState().address }}</p>
                <button
                  type="button"
                  class="copy-address-btn"
                  (click)="copyWalletAddress()"
                  title="Copy address"
                >
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                  </svg>
                  Copy
                </button>
              </div>
            </div>
            
            <p class="qr-instructions">
              Share this QR code or wallet address to receive payments. Anyone can send ETH to this address.
            </p>
          </div>
        </div>
      }
      @if (!walletState().connected && isAuthenticated()) {
        <div class="wallet-prompt">
          <p>üîê <strong>Connect your wallet:</strong> You can use an existing wallet address with funds, or create a new one.</p>
          <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0; color: #bcc2d8; font-size: 0.875rem;">
            <li><strong>To use an existing wallet:</strong> Import it into MetaMask first (MetaMask ‚Üí Account menu ‚Üí Import Account), then click "Connect Your MetaMask Wallet" and select it.</li>
            <li><strong>To create a new wallet:</strong> Click "Connect Your MetaMask Wallet" and MetaMask will guide you to create one.</li>
          </ul>
          <p style="margin-top: 0.75rem; margin-bottom: 0; color: #8d92aa; font-size: 0.8125rem;">Each user account must have its own unique wallet address linked to their phone number.</p>
        </div>
      }
    </div>
    <div class="hero-card">
      <div class="card-header">
        <p>Status</p>
        <span class="status-dot" [class.connected]="walletState().connected"></span>
        <span>{{ walletState().connected ? 'Wallet linked' : 'Awaiting connection' }}</span>
      </div>
      <div class="card-body">
        <p class="label">Primary wallet</p>
        <h3>{{ formatAddress(walletState().address) }}</h3>
        <p class="subtle">{{ walletState().networkName }}</p>

        <div class="balance-tile">
          <p>Live balance</p>
          <h2>{{ walletState().balance }} ETH</h2>
          
          @if (walletState().connected && exchangeRates()) {
            <div class="currency-selector" style="margin-top: 1rem;">
              <label style="font-size: 0.75rem; color: #9aa0bf; margin-bottom: 0.5rem; display: block;">
                Convert To
              </label>
              <select 
                [value]="selectedFiatCurrency()"
                (change)="selectedFiatCurrency.set($any($event.target).value)"
                class="currency-select"
              >
                @for (currency of fiatCurrencies; track currency.code) {
                  <option [value]="currency.code">{{ currency.code }}</option>
                }
              </select>
            </div>
            
            <div class="converted-balance" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.08);">
              <p style="font-size: 0.75rem; color: #9aa0bf; margin-bottom: 0.25rem;">Converted Value</p>
              <h3 style="font-size: 1.5rem; margin: 0; color: #6cf0ff;">
                {{ convertedBalance.symbol }}{{ convertedBalance.value }}
              </h3>
              <p style="font-size: 0.75rem; color: #9aa0bf; margin-top: 0.25rem;">{{ selectedFiatCurrency() }}</p>
            </div>
            
            <button
              type="button"
              class="refresh-balance-btn"
              (click)="refreshWalletBalance()"
              [disabled]="refreshingBalance()"
              style="margin-top: 1rem; width: 100%;"
            >
              @if (refreshingBalance()) {
                <span class="loader"></span>
                Refreshing...
              } @else {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; margin-right: 0.5rem;">
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                Refresh Balance
              }
            </button>
          }
        </div>

        <div class="card-foot">
          <p>Chain ID</p>
          <span>{{ walletState().chainId ?? '‚Äî' }}</span>
        </div>
        
        @if (walletState().connected && walletState().address) {
          <div class="card-foot" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 0.75rem;">
            <button 
              type="button" 
              class="ghost tiny" 
              (click)="toggleWalletAddressDisplay()"
              style="width: 100%; text-align: center;"
            >
              {{ showWalletAddress() ? 'Hide' : 'Show' }} Full Address
            </button>
            @if (showWalletAddress()) {
              <div style="padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.1); word-break: break-all;">
                <p style="font-family: monospace; font-size: 0.75rem; color: #6cf0ff; margin: 0; line-height: 1.5;">
                  {{ walletState().address }}
                </p>
              </div>
            }
          </div>
        }
    </div>
      @if (isMetaMaskMissing()) {
        <a
          class="meta-warning"
          href="https://metamask.io/download/"
            target="_blank"
            rel="noopener"
          >
          Install MetaMask to continue
          </a>
        }
      </div>
  </header>


  <section class="payment-grid">
    <article class="panel">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Send a blockchain payment</p>
          <h2>Authorize a settlement</h2>
        </div>
        <span class="inline-status" [class.ready]="walletState().connected">
          {{ walletState().connected ? 'Connected' : 'Wallet idle' }}
        </span>
      </div>

      <form [formGroup]="paymentForm" (ngSubmit)="submitPayment()" novalidate>
        <div class="field-row">
          <label>
            Amount
            <input type="number" step="0.0001" min="0" formControlName="amount" placeholder="0.00" />
          </label>
          <label>
            Asset
            <select formControlName="currency">
              <option value="USDC">USDC</option>
              <option value="USDT">USDT</option>
              <option value="ETH">ETH</option>
            </select>
          </label>
        </div>

        <label>
          Recipient wallet
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input
              type="text"
              formControlName="recipientWallet"
              placeholder="0x87...ff23 or use phone search above"
              autocomplete="off"
              style="flex: 1;"
            />
            @if (paymentForm.get('recipientWallet')?.value && walletState().connected) {
              <button
                type="button"
                class="ghost tiny"
                (click)="openPaymentModal(paymentForm.get('recipientWallet')?.value || '')"
                title="Open payment modal"
              >
                Send
              </button>
            }
          </div>
        </label>

        <label>
          Internal reference (optional)
          <input type="text" formControlName="reference" placeholder="Invoice #123" />
        </label>

        <label>
          Memo (optional)
          <textarea rows="3" formControlName="memo" placeholder="Share additional context"></textarea>
        </label>

        <button type="submit" class="primary block" [disabled]="submittingPayment()">
          {{ submittingPayment() ? 'Dispatching...' : 'Dispatch payment intent' }}
        </button>
      </form>
    </article>

    <article class="panel activity">
      <div class="panel-head">
        <div>
          <p class="eyebrow">Transaction history</p>
          <h2>Latest activity</h2>
          @if (isAuthenticated()) {
            <small style="display: block; color: #8d92aa; font-size: 0.75rem; margin-top: 0.25rem;">Showing your recent transactions</small>
          }
        </div>
        <button type="button" class="ghost tiny" (click)="loadRecentPayments()" [disabled]="!isAuthenticated()" title="Refresh transaction history">Refresh</button>
      </div>
      <ul>
        @for (payment of payments(); track payment.id) {
          <li class="transaction-item">
            <div class="transaction-main">
              <div class="transaction-info">
                <div class="transaction-amount-row">
                  <span class="transaction-type-icon" [class.sent]="isTransactionSent(payment)" [class.received]="!isTransactionSent(payment)">
                    {{ isTransactionSent(payment) ? '‚àí' : '+' }}
                  </span>
                  <p class="transaction-amount">
                    {{ payment.amount }} {{ payment.currency }}
                  </p>
                </div>
                <p class="transaction-hash">
                  @if (isTransactionSent(payment)) {
                    To: {{ formatAddress(payment.to_address) }}
                  } @else {
                    From: {{ formatAddress(payment.from_address || payment.to_address) }}
                  }
                </p>
                @if (payment.transaction_hash) {
                  <p class="transaction-hash-full" style="font-family: monospace; font-size: 0.7rem; color: #8d92aa; word-break: break-all;">
                    {{ payment.transaction_hash }}
                  </p>
                }
                <p class="transaction-date">
                  <span class="date-label">{{ payment.createdAt | date:'MMM d, y' }}</span>
                  <span class="time-label">{{ payment.createdAt | date:'h:mm a' }}</span>
                </p>
              </div>
              <div class="transaction-status">
                <span [class]="statusClass(payment.status)">
                  {{ payment.status }}
                </span>
              </div>
            </div>
            @if (payment.description) {
              <div class="transaction-description">
                <p class="description-label">Description:</p>
                <p class="description-text">{{ payment.description }}</p>
              </div>
            }
          </li>
        }
        @if (payments().length === 0) {
          <li class="transaction-empty">
            <p>No recent transactions</p>
          </li>
        }
      </ul>
    </article>
  </section>

  <section class="feature-grid">
    @for (feature of features; track feature.title) {
      <article>
        <h3>{{ feature.title }}</h3>
        <p>{{ feature.body }}</p>
      </article>
    }
  </section>

  <section class="workflow">
    <div>
      <p class="eyebrow">Simple and secure</p>
      <h2>How to send a payment</h2>
      <p>
        Send blockchain payments quickly and securely. Connect your wallet, enter the payment details,
        and confirm the transaction. Your payment will be processed on the blockchain instantly.
      </p>
    </div>
    <ol>
      @for (step of workflow; track step.title; let idx = $index) {
        <li>
          <span class="badge">0{{ idx + 1 }}</span>
          <div>
            <h3>{{ step.title }}</h3>
            <p>{{ step.body }}</p>
          </div>
        </li>
      }
    </ol>
  </section>

    <section class="cta">
      <div>
        <p>Ready to launch?</p>
        <h2>Connect MetaMask and settle your first on-chain payment.</h2>
      </div>
      <button type="button" class="secondary" (click)="connectWallet()">Link wallet</button>
    </section>
  }

  <!-- Account Settings Tile -->
  @if (showAccountSettings() && isAuthenticated()) {
    <div class="action-tile account-settings-tile">
      <div class="tile-header">
        <h3>Manage Account</h3>
        <button type="button" class="tile-close" (click)="toggleAccountSettings()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="tile-content account-settings-content">
        <!-- Change Password Section -->
        <div class="account-section">
          <button
            type="button"
            class="account-action-btn"
            (click)="toggleChangePasswordForm()"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Change Password
          </button>
          @if (showChangePasswordForm()) {
            <div class="account-form">
              <div class="form-group">
                <label>Old Password</label>
                <input
                  type="password"
                  [value]="oldPassword()"
                  (input)="oldPassword.set($any($event.target).value)"
                  placeholder="Enter current password"
                />
              </div>
              <div class="form-group">
                <label>New Password</label>
                <input
                  type="password"
                  [value]="newPassword()"
                  (input)="newPassword.set($any($event.target).value)"
                  placeholder="Enter new password"
                />
              </div>
              <button
                type="button"
                class="primary"
                (click)="submitChangePassword()"
                [disabled]="isProcessingAccountAction() || !oldPassword() || !newPassword()"
                [class.disabled]="isProcessingAccountAction() || !oldPassword() || !newPassword()"
              >
                @if (isProcessingAccountAction()) {
                  <span class="loader"></span>
                  Updating...
                } @else {
                  Submit
                }
              </button>
            </div>
          }
        </div>

        <!-- Update Email Section -->
        <div class="account-section">
          <button
            type="button"
            class="account-action-btn"
            (click)="toggleUpdateEmailForm()"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            Change Email
          </button>
          @if (showUpdateEmailForm()) {
            <div class="account-form">
              <div class="form-group">
                <label>New Email</label>
                <input
                  type="email"
                  [value]="newEmail()"
                  (input)="newEmail.set($any($event.target).value)"
                  placeholder="Enter new email address"
                />
              </div>
              <div class="form-group">
                <label>Password</label>
                <input
                  type="password"
                  [value]="accountPassForEmail()"
                  (input)="accountPassForEmail.set($any($event.target).value)"
                  placeholder="Enter your password"
                />
              </div>
              <button
                type="button"
                class="primary"
                (click)="submitUpdateEmail()"
                [disabled]="isProcessingAccountAction() || !newEmail() || !accountPassForEmail()"
                [class.disabled]="isProcessingAccountAction() || !newEmail() || !accountPassForEmail()"
              >
                @if (isProcessingAccountAction()) {
                  <span class="loader"></span>
                  Updating...
                } @else {
                  Submit
                }
              </button>
            </div>
          }
        </div>

        <!-- Delete Account Section -->
        <div class="account-section">
          <button
            type="button"
            class="account-action-btn delete-btn"
            (click)="toggleDeleteAccountForm()"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete Account
          </button>
          @if (showDeleteAccountForm()) {
            <div class="account-form">
              <div class="form-group">
                <label>Password</label>
                <input
                  type="password"
                  [value]="accountPassForDelete()"
                  (input)="accountPassForDelete.set($any($event.target).value)"
                  placeholder="Enter your password to confirm"
                />
              </div>
              <button
                type="button"
                class="primary delete-account-btn"
                (click)="submitDeleteAccount()"
                [disabled]="isProcessingAccountAction() || !accountPassForDelete()"
                [class.disabled]="isProcessingAccountAction() || !accountPassForDelete()"
              >
                @if (isProcessingAccountAction()) {
                  <span class="loader"></span>
                  Deleting...
                } @else {
                  Delete Account
                }
              </button>
            </div>
          }
        </div>
      </div>
    </div>
  }

<router-outlet />
</div>
